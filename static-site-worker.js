// Cloudflare Worker for SA1L.CC static site
// Handles HTML partial includes via HTMLRewriter
// 
// THIS FILE IS AUTO-GENERATED by build-worker.js
// DO NOT EDIT DIRECTLY - Edit files in /partials/ instead

const PARTIALS = {
  "auth-modal": "<!-- Auth Modal -->\n<div id=\"auth-modal\" class=\"auth-modal\">\n  <div class=\"auth-modal-content\">\n    <button id=\"auth-modal-close\" class=\"auth-modal-close\">&times;</button>\n    <h2>━━━ Login ━━━</h2>\n    <p class=\"small-text center-text\">log in with:</p>\n    <div class=\"auth-buttons\">\n      <button id=\"modal-login-google\"><img src=\"/img/google.svg\" alt=\"\" class=\"button-icon\">Google</button>\n      <button id=\"modal-login-github\"><img src=\"/img/github.svg\" alt=\"\" class=\"button-icon\">GitHub</button>\n    </div>\n    \n    <!--<div class=\"auth-email-section\">\n      <input id=\"modal-email\" type=\"email\" placeholder=\"Email\" />\n      <input id=\"modal-password\" type=\"password\" placeholder=\"Password\" />\n      <div class=\"auth-email-buttons\">\n        <button id=\"modal-login-email\">Login</button>\n        <button id=\"modal-signup-email\">Sign Up</button>\n      </div>\n    </div>-->\n  </div>\n</div>\n",
  "consent-modal": "<!-- Cookie Consent Modal -->\n<div id=\"consent-modal\" class=\"consent-modal\">\n  <div class=\"consent-content\">\n    <div class=\"consent-header\">\n      <div class=\"consent-title\">Cookie Consent</div>\n      <div class=\"consent-description\">\n        We use cookies to improve your experience and show relevant ads.\n      </div>\n    </div>\n    \n    <!-- Main View -->\n    <div id=\"consent-main\">\n      <div class=\"consent-body\">\n        <div class=\"consent-section\">\n          <div class=\"consent-section-title\">Your Privacy Matters</div>\n          <div class=\"consent-section-desc\">\n            We respect your privacy. Choose how we use cookies on this site.\n          </div>\n        </div>\n      </div>\n      \n      <div class=\"consent-actions\">\n        <button id=\"consent-accept-all\" class=\"consent-primary-btn\">\n          Accept All Cookies\n        </button>\n        <div class=\"consent-links\">\n          <a href=\"#\" id=\"consent-reject-all\">reject all</a> · \n          <a href=\"#\" id=\"consent-customize\">customize preferences</a>\n        </div>\n      </div>\n    </div>\n\n    <!-- Custom Preferences View -->\n    <div id=\"consent-custom\">\n      <div class=\"consent-body\">\n        <div class=\"consent-option\">\n          <input type=\"checkbox\" id=\"consent-necessary\" checked disabled>\n          <label for=\"consent-necessary\" class=\"consent-option-label\">\n            <span class=\"consent-option-name\">Necessary</span>\n            <span class=\"consent-option-desc\">Required for site functionality. Cannot be disabled.</span>\n          </label>\n        </div>\n\n        <div class=\"consent-option\">\n          <input type=\"checkbox\" id=\"consent-analytics\">\n          <label for=\"consent-analytics\" class=\"consent-option-label\">\n            <span class=\"consent-option-name\">Analytics</span>\n            <span class=\"consent-option-desc\">Helps us understand how visitors use our site.</span>\n          </label>\n        </div>\n\n        <div class=\"consent-option\">\n          <input type=\"checkbox\" id=\"consent-ads\">\n          <label for=\"consent-ads\" class=\"consent-option-label\">\n            <span class=\"consent-option-name\">Advertising</span>\n            <span class=\"consent-option-desc\">Allows us to show relevant ads and measure their performance.</span>\n          </label>\n        </div>\n\n        <div class=\"consent-option\">\n          <input type=\"checkbox\" id=\"consent-personalization\">\n          <label for=\"consent-personalization\" class=\"consent-option-label\">\n            <span class=\"consent-option-name\">Personalization</span>\n            <span class=\"consent-option-desc\">Remembers your preferences and settings.</span>\n          </label>\n        </div>\n      </div>\n\n      <div class=\"consent-actions\">\n        <button id=\"consent-accept-all-custom\" class=\"consent-primary-btn\">\n          Accept All Cookies\n        </button>\n        <button id=\"consent-save-custom\" class=\"consent-primary-btn\" style=\"margin-top: 10px;\">\n          Save Preferences\n        </button>\n      </div>\n    </div>\n\n    <div class=\"consent-footer\"></div>\n  </div>\n</div>\n",
  "firebase-init": "<!-- Firebase Auth (CDN, no build step) -->\n<script type=\"module\">\n  import { initializeApp } from \"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js\";\n  import {\n    getAuth,\n    onAuthStateChanged,\n    signInWithPopup,\n    GoogleAuthProvider,\n    GithubAuthProvider,\n    signInWithEmailAndPassword,\n    createUserWithEmailAndPassword,\n    signOut\n  } from \"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js\";\n\n  const firebaseConfig = {\n    apiKey: \"AIzaSyD-f9TGmva8BXdX6_b460tdrUkzTGkbjjw\",\n    authDomain: \"qr-redirect-site-1f3b9.firebaseapp.com\",\n    projectId: \"qr-redirect-site-1f3b9\",\n    storageBucket: \"qr-redirect-site-1f3b9.firebasestorage.app\",\n    messagingSenderId: \"897097551184\",\n    appId: \"1:897097551184:web:aca2f4c3aeac4f21b4b055\"\n  };\n\n  const app = initializeApp(firebaseConfig);\n  const auth = getAuth(app);\n\n  // Expose a tiny surface area to script.js\n  window.firebaseAuth = {\n    auth,\n    onAuthStateChanged,\n    signInWithPopup,\n    signInWithEmailAndPassword,\n    createUserWithEmailAndPassword,\n    signOut,\n    GoogleAuthProvider,\n    GithubAuthProvider\n  };\n</script>\n",
  "page-overlay": "<div id=\"page-transition-overlay\" class=\"page-transition-overlay visible\">\n  <div class=\"spinner\" role=\"status\" aria-live=\"polite\">\n    <div class=\"spinner-animation\" aria-hidden=\"true\"></div>\n    <div class=\"spinner-text\">--- LOADING ---</div>\n  </div>\n</div>\n",
  "site-header": "<div class=\"receipt-header\">\n  <pre class=\"site-logo\"></pre>\n  <h1 class=\"site-logo-text\">SA1L.CC</h1>\n  <div class=\"site-description\">generate and manage short qr redirect links</div>\n</div>\n",
  "useful-links": "<!-- Useful Links Section -->\n<div class=\"receipt-section\">\n  <div class=\"section-title\">━━━ useful links ━━━</div>\n  <p style=\"text-align: center;\">\n    <a href=\"#\" onclick=\"window.SA1LConsent.showModal(); return false;\">manage cookie preferences</a>\n  </p>\n</div>\n"
};

// HTMLRewriter handler for [data-include] elements
class IncludeHandler {
  constructor(partialName) {
    this.partialName = partialName;
  }

  element(element) {
    const content = PARTIALS[this.partialName];
    if (content) {
      element.setInnerContent(content, { html: true });
      element.removeAttribute('data-include');
    }
  }
}

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // Get the origin response
    const response = await fetch(request);
    
    // Only process HTML pages
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('text/html')) {
      return response;
    }

    // Apply HTMLRewriter to inject partials
    let rewriter = new HTMLRewriter();
    
    // Add handlers for each partial type
    Object.keys(PARTIALS).forEach(partialName => {
      rewriter = rewriter.on(`[data-include="${partialName}"]`, new IncludeHandler(partialName));
    });

    // Also inject CF-IPCountry as meta tag for consent.js geo-detection
    rewriter = rewriter.on('head', {
      element(element) {
        const country = request.cf?.country || 'UNKNOWN';
        element.append(`<meta name="cf-country" content="${country}">`, { html: true });
      }
    });

    return rewriter.transform(response);
  }
};
