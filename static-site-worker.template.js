// Cloudflare Worker for SA1L.CC static site
// Handles HTML partial includes via HTMLRewriter
// 
// THIS FILE IS AUTO-GENERATED by build-worker.js
// DO NOT EDIT DIRECTLY - Edit files in /partials/ instead

const PARTIALS = {{PARTIALS}};

// HTMLRewriter handler for [data-include] elements
class IncludeHandler {
  constructor(partialName) {
    this.partialName = partialName;
  }

  element(element) {
    const content = PARTIALS[this.partialName];
    if (content) {
      element.setInnerContent(content, { html: true });
      element.removeAttribute('data-include');
    }
  }
}

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // Handle extensionless URLs - try adding .html
    let response = await env.ASSETS.fetch(request);
    
    // If we get a 404 and the path doesn't have an extension, try adding .html
    if (response.status === 404 && !url.pathname.includes('.')) {
      const htmlUrl = new URL(request.url);
      htmlUrl.pathname = url.pathname.endsWith('/') 
        ? `${url.pathname}index.html`
        : `${url.pathname}.html`;
      
      const modifiedRequest = new Request(htmlUrl, request);
      response = await env.ASSETS.fetch(modifiedRequest);
    }
    
    // Only process HTML pages
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('text/html')) {
      return response;
    }

    // Apply HTMLRewriter to inject partials
    let rewriter = new HTMLRewriter();
    
    // Add handlers for each partial type
    Object.keys(PARTIALS).forEach(partialName => {
      rewriter = rewriter.on(`[data-include="${partialName}"]`, new IncludeHandler(partialName));
    });

    // Also inject CF-IPCountry as meta tag for consent.js geo-detection
    rewriter = rewriter.on('head', {
      element(element) {
        const country = request.cf?.country || 'UNKNOWN';
        element.append(`<meta name="cf-country" content="${country}">`, { html: true });
      }
    });

    return rewriter.transform(response);
  }
};
